<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WxCC Visualizer v23.0</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/style.css" />

    <style>
        body, html, #root { width: 100%; height: 100%; margin: 0; padding: 0; background: #f0f2f5; font-family: "Segoe UI", sans-serif; }
        
        .controls-panel {
            position: absolute; top: 20px; left: 20px; width: 340px; z-index: 1000;
            background: white; border: 1px solid #ced4da; border-radius: 8px; padding: 15px;
        }

        /* --- THE ACCURATE CASE NODE --- */
        .wx-node {
            width: 280px; background: white; border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #dee2e6;
            overflow: visible; display: flex; flex-direction: column;
        }

        /* Header: Teal with Icon */
        .wx-header {
            padding: 10px 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;
        }
        .wx-icon-box {
            width: 32px; height: 32px; background: #00b0ad; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;
        }
        .wx-header-text { display: flex; flex-direction: column; }
        .wx-node-name { font-weight: 700; font-size: 13px; color: #333; line-height: 1.2; }
        .wx-node-type { font-size: 10px; color: #888; text-transform: capitalize; }

        /* Variable Expression Box */
        .wx-variable-area {
            padding: 8px 12px; background: #fdfdfd; font-size: 11px; color: #0056b3;
            font-weight: 600; border-bottom: 1px solid #f0f0f0; font-family: Consolas, monospace;
        }

        /* Section Labels (Grey bars) */
        .wx-section-label {
            background: #f1f3f5; padding: 4px 12px; font-size: 10px; color: #666;
            font-weight: 700; text-transform: uppercase; border-bottom: 1px solid #e9ecef;
        }

        /* Outcome Rows (The exit points) */
        .wx-outcome-row {
            position: relative; padding: 8px 12px; border-bottom: 1px solid #f8f9fa;
            display: flex; justify-content: space-between; align-items: center; height: 36px;
        }
        .wx-outcome-label { font-size: 12px; color: #444; font-weight: 500; }
        .wx-error-label { color: #d63939; font-weight: 700; }

        /* Handle Styling */
        .react-flow__handle { width: 10px; height: 10px; background: #6c757d; border: 2px solid white; z-index: 100; }
        .target-handle { left: -6px; top: 26px !important; }
        .source-handle { right: -6px; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "reactflow": "https://esm.sh/reactflow@11.10.1?external=react,react-dom",
            "dagre": "https://esm.sh/dagre@0.8.5"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState } from 'react';
        import { createRoot } from 'react-dom/client';
        import ReactFlow, { Controls, Background, applyEdgeChanges, applyNodeChanges, Handle, Position } from 'reactflow';

        const nodeTypes = {
            wxNode: ({ data }) => (
                <div className="wx-node">
                    <Handle type="target" position={Position.Left} className="target-handle" />
                    
                    {/* TOP HEADER */}
                    <div className="wx-header">
                        <div className="wx-icon-box"><i className={`fa-solid ${data.icon}`}></i></div>
                        <div className="wx-header-text">
                            <div className="wx-node-name">{data.label}</div>
                            <div className="wx-node-type">{data.typeName}</div>
                        </div>
                    </div>

                    {/* VARIABLE DISPLAY */}
                    {data.expression && <div className="wx-variable-area">{data.expression}</div>}

                    {/* DYNAMIC CASE ROWS */}
                    {data.isCase && <div className="wx-section-label">Case</div>}
                    <div className="wx-outcome-container">
                        {data.outcomes && data.outcomes.map((out, i) => (
                            <div key={i} className="wx-outcome-row">
                                <span className="wx-outcome-label">{out}</span>
                                <Handle type="source" position={Position.Right} id={out} className="source-handle" />
                            </div>
                        ))}
                    </div>

                    {/* DEFAULT & ERROR FOOTERS */}
                    {data.isCase && (
                        <>
                            <div className="wx-section-label">Default</div>
                            <div className="wx-outcome-row">
                                <span className="wx-outcome-label">Default</span>
                                <Handle type="source" position={Position.Right} id="Default" className="source-handle" />
                            </div>
                            <div className="wx-section-label">Error Handling</div>
                            <div className="wx-outcome-row">
                                <span className="wx-outcome-label wx-error-label">Undefined Errors</span>
                                <Handle type="source" position={Position.Right} id="Undefined Errors" className="source-handle" />
                            </div>
                        </>
                    )}

                    {/* Simple output for Play Message/Start etc */}
                    {!data.isCase && (
                        <div className="wx-outcome-row" style={{justifyContent:'flex-end', height: '10px'}}>
                            <Handle type="source" position={Position.Right} id="default" className="source-handle" />
                        </div>
                    )}
                </div>
            )
        };

        const parseFlow = (json) => {
            const nodes = [];
            const edges = [];
            const activities = json.process?.activities || {};
            const links = json.process?.links || [];
            const widgets = json.diagram?.widgets || {};

            Object.values(activities).forEach(act => {
                const activityName = act.activityName || '';
                let icon = 'fa-gear';
                let outcomes = [];
                let expression = null;
                let isCase = false;
                let typeName = activityName;

                // DETECT CASE NODES IN YOUR JSON
                if (activityName.toLowerCase().includes('case') || activityName.toLowerCase().includes('switch')) {
                    isCase = true;
                    icon = 'fa-code-branch';
                    typeName = 'Case';
                    expression = act.properties?.expression || '';
                    // Extract case names from properties
                    if (act.properties?.cases) {
                        outcomes = Object.keys(act.properties.cases);
                    }
                } 
                else if (activityName.toLowerCase().includes('menu')) {
                    isCase = true; // Treating menu as branching for layout
                    icon = 'fa-list-ul';
                    typeName = 'Menu';
                    if (act.properties?.menuLinks) {
                        outcomes = Object.keys(act.properties.menuLinks);
                    }
                }
                else if (activityName.toLowerCase().includes('phone') || activityName.toLowerCase().includes('start')) {
                    icon = 'fa-play';
                    typeName = 'Start';
                }

                nodes.push({
                    id: act.id,
                    type: 'wxNode',
                    position: { x: widgets[act.id]?.point?.x || 0, y: widgets[act.id]?.point?.y || 0 },
                    data: { 
                        label: act.name, 
                        typeName: typeName, 
                        icon: icon, 
                        expression: expression, 
                        outcomes: outcomes, 
                        isCase: isCase 
                    }
                });
            });

            links.forEach(l => {
                let sHandle = l.conditionExpr || 'default';
                if (sHandle === 'true') sHandle = 'Default';
                
                // If the link is an error type, snap to error handle
                if (l.type === 'error') sHandle = 'Undefined Errors';

                edges.push({
                    id: `${l.sourceActivityId}-${l.targetActivityId}`,
                    source: l.sourceActivityId,
                    target: l.targetActivityId,
                    sourceHandle: sHandle,
                    type: 'smoothstep',
                    style: { stroke: sHandle.includes('Error') ? '#d63939' : '#b1b1b7', strokeWidth: 2 }
                });
            });

            return { nodes, edges };
        };

        const App = () => {
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            
            const handleFile = (e) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const data = JSON.parse(ev.target.result);
                    const { nodes: n, edges: ed } = parseFlow(data);
                    setNodes(n); setEdges(ed);
                };
                reader.readAsText(e.target.files[0]);
            };

            return (
                <div style={{ width: '100vw', height: '100vh' }}>
                    <div className="controls-panel">
                        <h6 className="fw-bold">WxCC Visualizer v23.0</h6>
                        <input type="file" onChange={handleFile} className="form-control form-control-sm mt-2" />
                    </div>
                    <ReactFlow nodes={nodes} edges={edges} 
                        onNodesChange={c => setNodes(nds => applyNodeChanges(c, nds))}
                        onEdgesChange={c => setEdges(eds => applyEdgeChanges(c, eds))}
                        nodeTypes={nodeTypes} fitView>
                        <Background color="#ddd" gap={20}/><Controls />
                    </ReactFlow>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
