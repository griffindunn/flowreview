<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WxCC Visualizer v20.0 (Debug Mode)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/style.css" />

    <style>
        body, html, #root { width: 100%; height: 100%; margin: 0; padding: 0; background: #e9ecef; font-family: "Segoe UI", Tahoma, sans-serif; }
        
        .controls-panel {
            position: absolute; top: 20px; left: 20px; width: 340px; z-index: 1000;
            background: white; border: 1px solid #ced4da; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 15px;
        }

        /* --- THE WEBEX "CASE" NODE CLONE --- */
        .wx-node {
            width: 280px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
            overflow: visible; /* Handles must be visible */
            display: flex;
            flex-direction: column;
        }

        /* Header Area */
        .wx-header {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #eee;
        }
        .wx-icon-box {
            width: 28px; height: 28px; background: #00b0ad; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; color: white;
        }
        .wx-node-name { font-weight: 700; font-size: 13px; color: #333; }
        .wx-node-type { font-size: 10px; color: #999; margin-left: auto; text-transform: uppercase; }

        /* Expression / Question Area */
        .wx-expr-area {
            padding: 8px 12px;
            background: #fdfdfd;
            font-size: 11px;
            color: #666;
            font-style: italic;
            border-bottom: 1px solid #f0f0f0;
        }

        /* Outcomes (The Connection Rows) */
        .wx-outcome-container { display: flex; flex-direction: column; }
        
        .wx-outcome-row {
            position: relative;
            padding: 8px 12px;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 36px;
        }
        .wx-outcome-row:last-child { border-bottom: none; }
        .wx-outcome-label { font-size: 12px; font-weight: 500; color: #444; }

        /* DEBUG HANDLE LABELS */
        .debug-label {
            position: absolute; right: -85px; top: 50%; transform: translateY(-50%);
            font-size: 9px; font-family: monospace; color: #dc3545; font-weight: bold;
            pointer-events: none; white-space: nowrap; background: rgba(255,255,255,0.8); padding: 1px 3px;
        }

        /* HANDLES */
        .react-flow__handle {
            width: 10px; height: 10px; background: #6c757d; border: 2px solid white;
            z-index: 100;
        }
        .target-handle { left: -6px; top: 24px !important; }
        .source-handle { right: -6px; }

        #crash-screen { padding: 40px; color: #721c24; background: #f8d7da; display: none; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; z-index: 9999; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "reactflow": "https://esm.sh/reactflow@11.10.1?external=react,react-dom",
            "dagre": "https://esm.sh/dagre@0.8.5"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <div id="crash-screen"><h3>Startup Error</h3><pre id="crash-msg"></pre></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import ReactFlow, { Controls, Background, applyEdgeChanges, applyNodeChanges, Handle, Position, MiniMap } from 'reactflow';

        window.onerror = (m, s, l) => {
            document.getElementById('crash-screen').style.display='block';
            document.getElementById('crash-msg').innerText = `${m}\nLine: ${l}`;
        };

        const nodeTypes = {
            wxNode: ({ data }) => (
                <div className="wx-node">
                    <Handle type="target" position={Position.Left} className="target-handle" />
                    
                    <div className="wx-header">
                        <div className="wx-icon-box"><i className={`fa-solid ${data.icon}`}></i></div>
                        <div className="wx-node-name">{data.label}</div>
                        <div className="wx-node-type">{data.typeName}</div>
                    </div>

                    {data.expression && <div className="wx-expr-area">({data.expression})</div>}

                    <div className="wx-outcome-container">
                        {data.outcomes && data.outcomes.map((out, i) => (
                            <div key={i} className="wx-outcome-row">
                                <span className="wx-outcome-label">{out}</span>
                                <Handle type="source" position={Position.Right} id={out} className="source-handle" />
                                <div className="debug-label">ID: {out}</div>
                            </div>
                        ))}
                        {(!data.outcomes || data.outcomes.length === 0) && (
                            <div className="wx-outcome-row" style={{justifyContent:'flex-end'}}>
                                <Handle type="source" position={Position.Right} id="default" className="source-handle" />
                                <div className="debug-label">ID: default</div>
                            </div>
                        )}
                    </div>
                </div>
            )
        };

        const parseFlow = (json) => {
            const nodes = [];
            const edges = [];
            const activities = json.process?.activities || {};
            const links = json.process?.links || [];
            const widgets = json.diagram?.widgets || {};

            Object.values(activities).forEach(act => {
                const type = act.activityName || 'activity';
                let icon = 'fa-gear';
                let outcomes = [];
                let expression = null;

                if (type.includes('case')) {
                    icon = 'fa-code-branch';
                    expression = act.properties?.expression;
                    outcomes = act.properties?.cases ? Object.keys(act.properties.cases) : [];
                    if (!outcomes.includes('Default')) outcomes.push('Default');
                } else if (type.includes('menu')) {
                    icon = 'fa-list-ul';
                    outcomes = act.properties?.menuLinks ? Object.keys(act.properties.menuLinks) : [];
                }

                nodes.push({
                    id: act.id,
                    type: 'wxNode',
                    position: { x: widgets[act.id]?.point?.x || 0, y: widgets[act.id]?.point?.y || 0 },
                    data: { label: act.name, typeName: type, icon, expression, outcomes, raw: act }
                });
            });

            links.forEach(l => {
                let sHandle = l.conditionExpr || 'default';
                if (sHandle === 'true' || sHandle === 'false') sHandle = 'Default';

                edges.push({
                    id: `${l.sourceActivityId}-${l.targetActivityId}`,
                    source: l.sourceActivityId,
                    target: l.targetActivityId,
                    sourceHandle: sHandle,
                    label: l.conditionExpr === 'true' ? '' : l.conditionExpr,
                    type: 'smoothstep',
                    style: { stroke: '#b1b1b7', strokeWidth: 2 }
                });
            });
            return { nodes, edges };
        };

        const App = () => {
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            
            const handleFile = (e) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const { nodes: n, edges: ed } = parseFlow(JSON.parse(ev.target.result));
                    setNodes(n); setEdges(ed);
                };
                reader.readAsText(e.target.files[0]);
            };

            return (
                <div style={{ width: '100vw', height: '100vh' }}>
                    <div className="controls-panel">
                        <h6>WxCC Visualizer v20.0</h6>
                        <input type="file" onChange={handleFile} className="form-control form-control-sm" />
                    </div>
                    <ReactFlow nodes={nodes} edges={edges} 
                        onNodesChange={c => setNodes(nds => applyNodeChanges(c, nds))}
                        onEdgesChange={c => setEdges(eds => applyEdgeChanges(c, eds))}
                        nodeTypes={nodeTypes} fitView>
                        <Background /><Controls />
                    </ReactFlow>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
